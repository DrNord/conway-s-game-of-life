/*!
Conway's Game of Life
Copyright (C) 2021 Dr. Nord
*/
"use strict";import*as t from"./common.js";import*as f from"./audio.js";import*as i from"./pageViewControl.js";import*as n from"../resources/color-parse-to-rgb/rgbcolor.js";let _=null;function e(){console.log("Initialize the Game of Life"),_=new a,_.w_engine.onmessage=e=>{let t=_;e=e.data;"data"===e.cmd?(t.fieldState.cells_alive=e.cells_alive,t.fieldState.data=e.field,t.fieldState.epoch_counter=e.counter,t.hud.epoch.innerText=t.fieldState.epoch_counter.toString(),t.visualize()):console.log("From worker-engine: command '"+e.cmd+"' is not supported.")},_.updateCell_GridPattern(),_.updateDrawDimensions(),_.fitField(),_.triggerUpdate_colors(),_.triggerUpdate_zoom(),_.setDt_forTimers(),_.restart(),_.play()}function a(){let e=this;e.hud=document.getElementById("hud-info"),e.hud.total=e.hud.getElementsByTagName("p")[0].getElementsByTagName("span")[1],e.hud.size_cxr=e.hud.getElementsByTagName("p")[1].getElementsByTagName("span")[1],e.hud.cell_cxr=e.hud.getElementsByTagName("p")[2].getElementsByTagName("span")[1],e.hud.alive=e.hud.getElementsByTagName("p")[3].getElementsByTagName("span")[1],e.hud.epoch=e.hud.getElementsByTagName("p")[4].getElementsByTagName("span")[1],e.container=document.getElementById("game-container"),e.viewport=document.getElementById("game-viewport"),e.scroll=document.getElementById("game-scroll"),e.field=document.getElementById("game-field"),e.canvas=document.getElementById("game-canvas"),e.canvas.usr_ctx=e.canvas.getContext("2d"),e.canvas_grid=document.getElementById("game-canvas-grid"),e.canvas_grid.usr_ctx=e.canvas_grid.getContext("2d"),e.canvas_grid_cell=document.createElement("canvas"),e.canvas_grid_cell.usr_ctx=e.canvas_grid_cell.getContext("2d"),e.canvas_grid_cell.usr_pattern=null,e.img_data=null,e.input=document.createElement("input"),e.input.type="file",e.input.onchange=()=>{e.loadField(e.input.files[0])},e.canvas_img=document.createElement("canvas"),e.canvas_img.usr_ctx=e.canvas_img.getContext("2d"),e.img_data_import=null,e.cell_size=6,e.cell_size_max=200,e.cell_size_min=1,e.spawn_point_start_coord={x:0,y:0},e.cols=0,e.rows=0,e.dt_epoch_ms=100,e.dt_epoch_min=0,e.dt_epoch_max=500,e.dt_frame_ms=1e3/60,e.dt_resize_ms=1,e.alive_probability=.3,e.scroll_x=0,e.scroll_y=0,e.scrollPos_calc={x:0,y:0},e.draw_dimension_x=null,e.draw_dimension_y=null,e.fieldState=new Array(1).fill(0),e.fieldState.cells_alive=0,e.fieldState.epoch_counter=0,e.fieldState.data=new Uint8Array(1).fill(0),e.w_engine=new Worker("./js/worker-engine.js"),e.is_playing=!1,e.is_visualizing=!1,e.is_visualizing_busy_triggered=!1,e.inst=OverlayScrollbars(document.getElementById("game-scroll"),{scrollbars:{clickScrolling:!0},callbacks:{onScroll:()=>{e.inst.usr_getScrollPosition(),e.triggerUpdate_scroll(),e.visualize()}}}),e.inst.usr_getScrollPosition=()=>{e.inst.update(!0),e.scroll_x=e.inst.scroll().position.x,e.scroll_y=e.inst.scroll().position.y},e.changeSimTime=E,e.fitField=v,e.cellSpawn=w,e.playPause=p,e.restart=y,e.fill=x,e.nextEpoch=D,e.zoomIn=z,e.zoomOut=b,e.zoomSlide=S,e.settingsApply=I,e.loadField=T,e.saveField=P,e.percentageVal=(e,t,i)=>(e-t)/(i-t)*100,e.play=N,e.pause=k,e.visualize=F,e.activateZoom=B,e.scaleVal=M,e.setDt_forTimers=C,e.updateField=l,e.updateViewport=s,e.updateCellsImagePixels=o,e.updateCell_GridPattern=c,e.updateCellsGrid=r,e.updateDrawDimensions=d,e.triggerUpdate_field=m,e.triggerUpdate_zoom=u,e.triggerUpdate_colors=h,e.triggerUpdate_scroll=g,t.resizeObserveWithDebounce(e.container,()=>{e.updateViewport(),e.visualize()},e.dt_resize_ms)}function l(){let e=_;e.field.style.width=Math.ceil(e.cols*e.cell_size)+"px",e.field.style.height=Math.ceil(e.rows*e.cell_size)+"px",e.updateViewport()}function s(){let e=_;var t=Math.ceil(parseFloat(window.getComputedStyle(e.viewport).borderLeftWidth));e.viewport.style.width=Math.min(Math.floor(e.container.clientWidth-2*t),Math.floor(parseFloat(e.field.style.width)+2*t))+"px",e.viewport.style.height=Math.min(Math.floor(e.container.clientHeight-2*t),Math.floor(parseFloat(e.field.style.height)+2*t))+"px",e.canvas.width=e.viewport.clientWidth,e.canvas.height=e.viewport.clientHeight,e.canvas.usr_ctx.imageSmoothingEnabled=!1,e.canvas_grid.width=e.canvas.width,e.canvas_grid.height=e.canvas.height,e.canvas_grid.usr_ctx.imageSmoothingEnabled=!0,e.scroll.style.width=e.viewport.clientWidth+"px",e.scroll.style.height=e.viewport.clientHeight+"px",e.inst.usr_getScrollPosition(),e.updateDrawDimensions(),e.updateCellsGrid()}function o(){var t=this,e=t.draw_dimension_x,i=t.draw_dimension_y,a=new n.RGBColor(window.getComputedStyle(document.body).getPropertyValue("--colorParticle"));t.img_data=new ImageData(e.cells_in_canvas_scope,i.cells_in_canvas_scope);for(let e=0;e<t.img_data.data.length;e+=4)t.img_data.data[e]=a.r,t.img_data.data[e+1]=a.g,t.img_data.data[e+2]=a.b,t.img_data.data[e+3]=0}function c(){var e=this;let t=e.canvas_grid_cell,i=new n.RGBColor(window.getComputedStyle(document.body).getPropertyValue("--colorCellStroke")),a=new n.RGBColor(window.getComputedStyle(document.body).getPropertyValue("--colorBorder01"));var l=Math.round(e.cell_size);t.width=l,t.height=l,t.usr_ctx.imageSmoothingEnabled=!0,t.usr_ctx.beginPath(),t.usr_ctx.fillStyle=i.toHex(),t.usr_ctx.rect(0,0,l,l),t.usr_ctx.fill();var s=.1*l;t.usr_ctx.globalCompositeOperation="destination-out";!function(e,t,i,a,l,s){var n=t+a,a=i+l;let o=e;o.beginPath(),o.moveTo(t+s,i),o.lineTo(n-s,i),o.quadraticCurveTo(n,i,n,i+s),o.lineTo(n,i+l-s),o.quadraticCurveTo(n,a,n-s,a),o.lineTo(t+s,a),o.quadraticCurveTo(t,a,t,a-s),o.lineTo(t,i+s),o.quadraticCurveTo(t,i,t+s,i),o.fill()}(t.usr_ctx,1.2*s,1.2*s,l-2.4*s,l-2.4*s,1.2*s),12<=l&&(t.usr_ctx.globalCompositeOperation="source-over",t.usr_ctx.beginPath(),t.usr_ctx.strokeStyle=a.toHex(),t.usr_ctx.lineWidth=s,t.usr_ctx.arc(l/2,l/2,l/2+.15*l,0,2*Math.PI),t.usr_ctx.stroke()),t.usr_ctx.globalCompositeOperation="source-over",t.usr_ctx.beginPath(),t.usr_ctx.strokeStyle=a.toHex(),t.usr_ctx.lineWidth=s,t.usr_ctx.rect(0,0,l,l),t.usr_ctx.stroke(),t.usr_pattern=e.canvas_grid.usr_ctx.createPattern(t,"repeat"),t.usr_matrix=new DOMMatrix([e.cell_size/l,0,0,e.cell_size/l,0,0])}function r(){var e=this;4<=e.cell_size?(e.canvas_grid_cell.usr_pattern.setTransform(e.canvas_grid_cell.usr_matrix.translate(-e.draw_dimension_x.cells_zoomed_shift,-e.draw_dimension_y.cells_zoomed_shift,0)),e.canvas_grid.usr_ctx.fillStyle=e.canvas_grid_cell.usr_pattern,e.canvas_grid.usr_ctx.clearRect(0,0,e.canvas_grid.width,e.canvas_grid.height),e.canvas_grid.usr_ctx.fillRect(0,0,e.canvas_grid.width,e.canvas_grid.height),e.canvas_grid.style.display=""):e.canvas_grid.style.display="none"}function d(){var e=this;e.draw_dimension_x=R(e.scroll_x,e.cell_size,e.canvas.width),e.draw_dimension_y=R(e.scroll_y,e.cell_size,e.canvas.height),e.updateCellsImagePixels()}function g(){this.updateDrawDimensions(),this.updateCellsGrid()}function m(){this.updateField(),this.updateCellsImagePixels(),this.updateCellsGrid()}function u(){this.updateCell_GridPattern(),this.updateField()}function h(){this.updateCellsImagePixels(),this.updateCell_GridPattern(),this.updateCellsGrid()}function p(){let e=_;e.is_playing?e.pause():e.play()}function v(){let e=_;var t=e.cell_size,i=Math.ceil(parseFloat(window.getComputedStyle(e.viewport).borderLeftWidth)),a=Math.floor((e.container.clientWidth-6*i-t)/t),t=Math.floor((e.container.clientHeight-6*i-t)/t);e.cols===a&&e.rows===t||(e.cols=a,e.rows=t,e.triggerUpdate_field(),e.w_engine.postMessage({cmd:"init",rows:e.rows,cols:e.cols}))}function y(){let e=_;e.w_engine.postMessage({cmd:"fill",alive_probability:e.alive_probability}),e.w_engine.postMessage({cmd:"get-data"})}function w(e,i,t){var a=this;let l=a.spawn_point_start_coord;var s=a.field.getBoundingClientRect(),n=e.clientX-s.x,s=e.clientY-s.y,n=Math.ceil(n/a.cell_size),s=Math.ceil(s/a.cell_size);if("game-field"!==e.target.id)return l.x=n,void(l.y=s);let o="";switch(t){case"game_edit_add":o="spawn";break;case"game_edit_erase":o="kill";break;case"game_edit_invert":o="invert"}if(1<=n&&n<=a.cols&&1<=s&&s<=a.rows){let t=[];if(i){let e={x:0,y:0};if(e.x=n,e.y=s,e.x!==l.x||e.y!==l.y){f.click_spawn.playRD();var c=e.x-l.x,r=e.y-l.y,d=Math.abs(c),_=Math.abs(r);if(_<=d){var g=_/d;for(let e=1;e<=d;e++){var m=l.x+e*Math.sign(c),u=Math.round(l.y+g*e*Math.sign(r)),m=(a.cols+2)*u+m;t.push(m)}}else{var h=d/_;for(let e=1;e<=_;e++){var p=l.y+e*Math.sign(r),v=Math.round(l.x+h*e*Math.sign(c)),v=(a.cols+2)*p+v;t.push(v)}}a.w_engine.postMessage({cmd:"edit_indices",indices:t,action:o}),l.x=e.x,l.y=e.y}}else{f.click_spawn.playRD(),l.x=n,l.y=s;n=(a.cols+2)*s+n;t.push(n),a.w_engine.postMessage({cmd:"edit_cell",row:l.y,col:l.x,action:o})}}}function x(e){let t=_;t.w_engine.postMessage({cmd:"fill",alive_probability:e}),t.w_engine.postMessage({cmd:"get-data"})}function z(){let e=_;e.cell_size=Math.floor(e.cell_size)+1,e.activateZoom()}function b(){let e=_;e.cell_size=Math.ceil(e.cell_size)-1,e.activateZoom()}function S(){let e=_;var t=i.getSliderPosition(this);e.cell_size=e.scaleVal(t,e.cell_size_min,e.cell_size_max),e.activateZoom()}function B(e){let t=_;t.cell_size>t.cell_size_max?t.cell_size=t.cell_size_max:t.cell_size<t.cell_size_min&&(t.cell_size=t.cell_size_min),document.getElementById("zoom_slider").value=t.percentageVal(t.cell_size,t.cell_size_min,t.cell_size_max).toString();let i;i=document.getElementById("game-scroll").getBoundingClientRect(),c=document.getElementById("game-field").getBoundingClientRect();let a,l;l=void 0!==e?(a=e.x,e.y):(a=i.x+i.width/2,i.y+i.height/2);var s=(a-c.x)/c.width,n=(l-c.y)/c.height,o=(a-i.x)/i.width,e=(l-i.y)/i.height;t.triggerUpdate_zoom(),i=document.getElementById("game-scroll").getBoundingClientRect(),c=document.getElementById("game-field").getBoundingClientRect(),document.getElementById("game-viewport").getBoundingClientRect();var s=s*c.width,c=n*c.height;let r=Math.round(s-o*i.width);r=r<0?0:r;let d=Math.round(c-e*i.height);d=d<0?0:d,t.inst.scroll({x:Math.round(r),y:Math.round(d)}),t.inst.update(!0),t.visualize()}function M(e,t,i){return e*(i-t)+t}function E(){let e=_;var t=document.getElementById("t_epoch"),t=1-i.getSliderPosition(t);e.dt_epoch_ms=e.scaleVal(t,e.dt_epoch_min,e.dt_epoch_max),e.setDt_forTimers()}function C(){var e=this.dt_frame_ms;this.w_engine.postMessage({cmd:"set_dt",dt_epoch_ms:this.dt_epoch_ms,dt_frame_ms:e})}function I(){let e=_,t=document.getElementById("settings_field_width"),i=Number(t.value);i<2&&(i=2),t.value=i.toString();let a=document.getElementById("settings_field_height"),l=Number(a.value);l<2&&(l=2),a.value=l.toString(),e.cols===i&&e.rows===l||(e.cols=i,e.rows=l,e.triggerUpdate_field(),e.w_engine.postMessage({cmd:"init",rows:e.rows,cols:e.cols}));let s=document.getElementById("settings_alive_probability"),n=Number(s.value);n<0&&(n=0),1<n&&(n=1),s.value=n.toString(),e.alive_probability=n;let o=document.getElementById("settings_dt_epoch_min"),c=Number(o.value);c<0&&(c=0),o.value=c.toString(),e.dt_epoch_min=c;let r=document.getElementById("settings_dt_epoch_max"),d=Number(r.value);d<=c&&(d=c+500),r.value=d.toString(),e.dt_epoch_max=d,e.dt_epoch_ms>e.dt_epoch_max&&(e.dt_epoch_ms=e.dt_epoch_max),e.dt_epoch_ms<e.dt_epoch_min&&(e.dt_epoch_ms=e.dt_epoch_min),document.getElementById("t_epoch").value=(100-e.percentageVal(e.dt_epoch_ms,e.dt_epoch_min,e.dt_epoch_max)).toString(),e.changeSimTime(),document.getElementById("game_settings").switch()}function T(e){let t=_,i=t.canvas_img,a;loadImage(e,e=>{i.width=e.width,i.height=e.height,i.usr_ctx.drawImage(e,0,0),a=i.usr_ctx.getImageData(0,0,i.width,i.height),t.cols=e.width,t.rows=e.height,t.triggerUpdate_field(),t.w_engine.postMessage({cmd:"init_image",image_data:a})})}function P(){var i=_;let a=new ImageData(i.cols,i.rows),e=i.canvas_img;e.width=i.cols,e.height=i.rows;var l;let s=0;for(let t=1;t<=i.rows;t++)for(let e=1;e<=i.cols;e++)l=t*(i.cols+2)+e,a.data[s]=255*i.fieldState.data[l],a.data[s+1]=255*i.fieldState.data[l],a.data[s+2]=0*i.fieldState.data[l],a.data[s+3]=255,s+=4;e.usr_ctx.putImageData(a,0,0);const t=document.createElement("a");t.download="game-field.png",t.href=e.toDataURL(),t.click(),t.delete}function D(){_.w_engine.postMessage({cmd:"next_epoch"})}function N(){this.is_playing=!0,this.w_engine.postMessage({cmd:"start"});let e=document.getElementById("playPause").getElementsByTagName("i")[0];e.classList.remove("fa-play-circle"),e.classList.add("fa-pause-circle")}function k(){this.is_playing=!1,this.w_engine.postMessage({cmd:"stop"});let e=document.getElementById("playPause").getElementsByTagName("i")[0];e.classList.remove("fa-pause-circle"),e.classList.add("fa-play-circle")}function R(e,t,i){var a=e/t,l=Math.floor(e/t),s=i/t,e=Math.ceil(i/t)+1,i=a-l;return{cells_scrolled_float:a,cells_scrolled_out:l,cells_in_canvas_float:s,cells_in_canvas_scope:e,cells_shift:i,cells_zoomed_shift:i*t,cell_visible_end_index:l+e}}function F(){let s=_;if(s.hud.total.innerText=Number(s.rows*s.cols).toString(),s.hud.size_cxr.innerText=s.cols.toString()+"x"+s.rows.toString(),s.hud.alive.innerText=s.fieldState.cells_alive.toString(),s.is_visualizing)s.is_visualizing_busy_triggered=!0;else{s.is_visualizing=!0;let i=s.draw_dimension_x,a=s.draw_dimension_y;var n;let l=0;for(let t=1+a.cells_scrolled_out;t<1+a.cell_visible_end_index;t++)for(let e=1+i.cells_scrolled_out;e<1+i.cell_visible_end_index;e++)n=t*(s.cols+2)+e,s.img_data.data[l+3]=255*s.fieldState.data[n],l+=4;createImageBitmap(s.img_data).then(e=>{s.canvas.usr_ctx.clearRect(0,0,s.canvas.width,s.canvas.height),s.canvas.usr_ctx.drawImage(e,i.cells_shift,a.cells_shift,i.cells_in_canvas_float,a.cells_in_canvas_float,0,0,s.canvas.width,s.canvas.height),s.is_visualizing=!1,s.is_visualizing_busy_triggered&&(s.is_visualizing_busy_triggered=!1,s.visualize())})}}export{_ as game,e as gameOfLife};