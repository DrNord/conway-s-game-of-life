/*!
Copyright (C) 2021 Dr. Nord
*/
let a=new i(2,2,"x32"),s=new Worker("worker-timer.js",{name:"epoch"}),l=new Worker("worker-timer.js",{name:"frame"});function i(t,e,a){switch(a){case"x32":this.bytesPlatform=4,this.youngerBitMask=16843009,DataView.prototype.getUintPlatform=DataView.prototype.getUint32,DataView.prototype.setUintPlatform=DataView.prototype.setUint32;break;case"x64-test":this.bytesPlatform=8,this.youngerBitMask=72340172838076670,DataView.prototype.getUintPlatform=DataView.prototype.getBigUint64,DataView.prototype.setUintPlatform=DataView.prototype.setBigUint64;break;default:this.bytesPlatform=1,this.youngerBitMask=1,DataView.prototype.getUintPlatform=DataView.prototype.getUint8,DataView.prototype.setUintPlatform=DataView.prototype.setUint8}this.rows=t+2,this.cols=e+2,this.cells_all=t*e,this.cells_alive=0,this.epoch_counter=0,this.data=new Uint8Array(this.rows*this.cols+this.bytesPlatform).fill(16),this.dataRaw=new DataView(this.data.buffer),this.dataNext=new Uint8Array(this.rows*this.cols+this.bytesPlatform).fill(16),this.dataNextRaw=new DataView(this.dataNext.buffer),this.print2d=r,this.fillRand_noBorder=o,this.fillImage_noBorder=c,this.lifeEpoch=d,this.editCell=n,this.editIndex=h,this.editIndices=_}function o(a){this.cells_alive=0;for(let e=1;e<this.rows-1;e++)for(let t=1;t<this.cols-1;t++){var s=e*this.cols+t;this.data[s]=Math.random()<a?1:0,this.cells_alive+=this.data[s]}}function c(a){let s=this.cells_alive=0;for(let e=1;e<this.rows-1;e++)for(let t=1;t<this.cols-1;t++){var l=e*this.cols+t;this.data[l]=.5<(a.data[s]+a.data[s+1]+a.data[s+2])/3/255?1:0,this.cells_alive+=this.data[l],s+=4}}function r(t){let s=0;switch(t){case"state":s=this.data;break;case"next":s=this.dataNext}for(let a=0;a<this.rows;a++){let e=" ";for(let t=0;t<this.cols;t++){var l=a*this.cols+t;e+=" "+(16===s[l]?"*":s[l])}console.log(e)}}function d(){this.cells_alive=0;for(let a=this.cols+1;a<(this.rows-1)*this.cols;a+=this.bytesPlatform){var s=this.dataRaw.getUintPlatform(a-this.cols-1)+this.dataRaw.getUintPlatform(a-this.cols)+this.dataRaw.getUintPlatform(a-this.cols+1)+this.dataRaw.getUintPlatform(a-1)+this.dataRaw.getUintPlatform(a+1)+this.dataRaw.getUintPlatform(a+this.cols-1)+this.dataRaw.getUintPlatform(a+this.cols)+this.dataRaw.getUintPlatform(a+this.cols+1),l=this.dataRaw.getUintPlatform(a),i=~(s>>2),o=s>>1;let t=(l&i&o|i&o&s)&this.youngerBitMask;t&=~(l>>4);l=t|l&this.youngerBitMask<<4;this.dataNextRaw.setUintPlatform(a,l);let e=0;for(e=0;t;e++)t&=t-1;this.cells_alive+=e}var t=this.data;this.data=this.dataNext,this.dataNext=t,this.dataRaw=new DataView(this.data.buffer),this.dataNextRaw=new DataView(this.dataNext.buffer),this.epoch_counter++}function n(t,e,a){e=this.cols*t+e;this.editIndex(e,a)}function h(t,e){var a=this,s=a.data[t];switch(e){case"spawn":a.data[t]=1;break;case"kill":a.data[t]=0;break;case"invert":a.data[t]=!a.data[t]}a.cells_alive+=a.data[t]-s}function _(t,e){let a=this;t.forEach(t=>a.editIndex(t,e))}l.is_triggered=!1,s.onmessage=()=>{a.lifeEpoch(),l.is_triggered&&(postMessage({cmd:"data",field:a.data,cells_all:a.cells_all,cells_alive:a.cells_alive,counter:a.epoch_counter}),l.is_triggered=!1,l.postMessage({cmd:"ready"})),s.postMessage({cmd:"ready"})},l.onmessage=()=>{l.is_triggered=!0},self.onmessage=function(t){var e=t.data;if(void 0!==e.cmd)switch(e.cmd){case"get-data":postMessage({cmd:"data",field:a.data,cells_all:a.cells_all,cells_alive:a.cells_alive,counter:a.epoch_counter});break;case"next_epoch":l.is_triggered=!0,s.postMessage({cmd:"act"});break;case"edit_cell":a.editCell(e.row,e.col,e.action),postMessage({cmd:"data",field:a.data,cells_all:a.cells_all,cells_alive:a.cells_alive,counter:a.epoch_counter});break;case"edit_indices":a.editIndices(e.indices,e.action),postMessage({cmd:"data",field:a.data,cells_all:a.cells_all,cells_alive:a.cells_alive,counter:a.epoch_counter});break;case"set_dt":s.postMessage({cmd:"set_dt",dt_ms:e.dt_epoch_ms}),l.postMessage({cmd:"set_dt",dt_ms:e.dt_frame_ms});break;case"start":s.postMessage({cmd:"start"}),l.postMessage({cmd:"start"});break;case"stop":s.postMessage({cmd:"stop"}),l.postMessage({cmd:"stop"}),postMessage({cmd:"data",field:a.data,cells_all:a.cells_all,cells_alive:a.cells_alive,counter:a.epoch_counter});break;case"start_game":s.postMessage({cmd:"start"});break;case"stop_game":s.postMessage({cmd:"stop"}),postMessage({cmd:"data",field:a.data,cells_all:a.cells_all,cells_alive:a.cells_alive,counter:a.epoch_counter});break;case"start_visual":l.postMessage({cmd:"start"});break;case"stop_visual":l.postMessage({cmd:"stop"}),postMessage({cmd:"data",field:a.data,cells_all:a.cells_all,cells_alive:a.cells_alive,counter:a.epoch_counter});break;case"init":a=new i(e.rows,e.cols,"x32"),a.fillRand_noBorder(0);break;case"init_image":a=new i(e.image_data.height,e.image_data.width,"x32"),a.fillImage_noBorder(e.image_data),a.epoch_counter=0,postMessage({cmd:"data",field:a.data,cells_all:a.cells_all,cells_alive:a.cells_alive,counter:a.epoch_counter});break;case"fill":a.fillRand_noBorder(e.alive_probability),a.epoch_counter=0;break;default:console.log("Worker-engine: the command '"+e.cmd+"' is not supported.")}},s.postMessage({cmd:"ready"}),l.postMessage({cmd:"ready"});